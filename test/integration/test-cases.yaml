config:
  inherit-env: true
  retries: 1

tests:
  auth0 tenants list:
    exit-code: 0

  auth0 roles list:
    exit-code: 0

  auth0 rules list:
    exit-code: 0

  auth0 completion bash:
    exit-code: 0

  auth0 completion zsh:
    exit-code: 0

  auth0 completion fish:
    exit-code: 0

  auth0 completion powershell:
    exit-code: 0

  # Test 'roles create'
  roles create and check data:
    command: auth0 roles create --name integration-test-role-new1 --description testRole --json --no-input
    exit-code: 0
    stdout:
      json:
        name: integration-test-role-new1
        description: testRole

  roles create and check output:
    command: auth0 roles create --name integration-test-role-new2 --description testRole2 --no-input
    stdout:
      contains:
        - NAME         integration-test-role-new2
        - DESCRIPTION  testRole2
    exit-code: 0

  roles list all with data:
    command: auth0 roles list
    exit-code: 0
    stdout:
      contains:
        - ID
        - NAME
        - DESCRIPTION

  roles list all with invalid number:
    command: auth0 roles list --number 1001
    exit-code: 1
    stderr:
      contains:
        - number flag invalid, please pass a number between 1 and 1000

  roles show json:
    command: auth0 roles show $(./test/integration/scripts/get-role-id.sh) --json
    stdout:
      json:
        name: integration-test-role-newRole
        description: integration-test-role
    exit-code: 0

  roles show:
    command: auth0 roles show $(./test/integration/scripts/get-role-id.sh)
    stdout:
      contains:
        - NAME         integration-test-role-newRole
        - DESCRIPTION  integration-test-role
    exit-code: 0

  # Test 'roles update'
  roles update name:
    command: auth0 roles update $(./test/integration/scripts/get-role-id.sh) --name integration-test-role-betterName --json
    stdout:
      json:
        name: integration-test-role-betterName
    exit-code: 0

  roles update description:
    command: auth0 roles update $(./test/integration/scripts/get-role-id.sh) --description betterDescription --json
    stdout:
      json:
        description: betterDescription
    exit-code: 0

  # Test 'rules create'
  rules create and check data:
    command: cat ./test/integration/fixtures/create-rule.json | jq '.[0]' | auth0 rules create --json
    stdout:
      json:
        name: integration-test-rule-new1
        enabled: "true"
        order: "1"
        script: "function(user, context, cb) {\n  cb(null, user, context);\n}\n"
    exit-code: 0

  rules create and check output:
    command: cat ./test/integration/fixtures/create-rule.json | jq '.[1]' | auth0 rules create
    stdout:
      contains:
        - NAME     integration-test-rule-new2
        - ENABLED  ✗
        - ORDER    2
        - SCRIPT   function(user, context, cb) {
    exit-code: 0
  
  rules list all with data:
    command: auth0 rules list
    exit-code: 0
    stdout:
      contains:
        - ID
        - NAME
        - ENABLED
        - ORDER

  rules show json:
    command: auth0 rules show $(./test/integration/scripts/get-rule-id.sh) --json
    stdout:
      json:
        name: integration-test-rule-newRule
        enabled: "true"
        order: "3"
    exit-code: 0

  rules show:
    command: auth0 rules show $(./test/integration/scripts/get-rule-id.sh)
    stdout:
      contains:
        - NAME     integration-test-rule-newRule
        - ENABLED  ✓
        - ORDER    3
    exit-code: 0

  # Test 'rules update'
  rules update:
    command: cat ./test/integration/fixtures/update-rule.json | auth0 rules update --json
    stdout:
      json:
        name: integration-test-rule-betterName
        enabled: "false"
    exit-code: 0

  # Test 'rules enable'
  rules enable:
    command: auth0 rules enable $(./test/integration/scripts/get-rule-id.sh) --json
    stdout:
      json:
        enabled: "true"
    exit-code: 0

  # Test 'rules disable'
  rules disable:
    command: auth0 rules disable $(./test/integration/scripts/get-rule-id.sh) --json
    stdout:
      json:
        enabled: "false"
    exit-code: 0

  attack protection breached password detection show:
    command: auth0 attack-protection breached-password-detection show
    stdout:
      contains:
        - ENABLED
        - SHIELDS
        - ADMIN_NOTIFICATION_FREQUENCY
        - METHOD
    exit-code: 0

  attack protection brute force protection show:
    command: auth0 attack-protection brute-force-protection show
    stdout:
      contains:
        - ENABLED
        - SHIELDS
        - ALLOW_LIST
        - MODE
        - MAX_ATTEMPTS
    exit-code: 0

  attack protection suspicious ip throttling show:
    command: auth0 attack-protection suspicious-ip-throttling show
    stdout:
      contains:
        - ENABLED
        - SHIELDS
        - ALLOW_LIST
        - STAGE_PRE_LOGIN_MAX_ATTEMPTS
        - STAGE_PRE_LOGIN_RATE
        - STAGE_PRE_USER_REGISTRATION_MAX_ATTEMPTS
        - STAGE_PRE_USER_REGISTRATION_RATE
    exit-code: 0

  attack protection suspicious ip throttling ips check:
    command: auth0 attack-protection suspicious-ip-throttling ips check 127.0.0.1
    stderr:
      contains:
        - "The IP 127.0.0.1 is not blocked."
    exit-code: 0

  attack protection suspicious ip throttling ips unblock:
    command: auth0 attack-protection suspicious-ip-throttling ips unblock 127.0.0.1
    stderr:
      contains:
        - "The IP 127.0.0.1 was unblocked."
    exit-code: 0

  attack protection update breached password detection:
    command: auth0 attack-protection breached-password-detection update --enabled
    stdout:
      contains:
        - ENABLED
        - SHIELDS
        - ADMIN_NOTIFICATION_FREQUENCY
        - METHOD
    exit-code: 0

  attack protection update brute force protection:
    command: auth0 attack-protection brute-force-protection update --enabled
    stdout:
      contains:
        - ENABLED
        - SHIELDS
        - ALLOW_LIST
        - MODE
        - MAX_ATTEMPTS
    exit-code: 0

  attack protection update suspicious ip throttling:
    command: auth0 attack-protection suspicious-ip-throttling update --enabled
    stdout:
      contains:
        - ENABLED
        - SHIELDS
        - ALLOW_LIST
        - STAGE_PRE_LOGIN_MAX_ATTEMPTS
        - STAGE_PRE_LOGIN_RATE
        - STAGE_PRE_USER_REGISTRATION_MAX_ATTEMPTS
        - STAGE_PRE_USER_REGISTRATION_RATE
    exit-code: 0

  update universal login branding prompts (login):
    command: cat ./test/integration/fixtures/update-ul-prompts-login.json | auth0 ul prompts update login
    exit-code: 0

  update universal login branding prompts (mfa-push):
    command: cat ./test/integration/fixtures/update-ul-prompts-mfa-push.json | auth0 ul prompts update mfa-push
    exit-code: 0

  tenants use:
    command: auth0 tenants use $AUTH0_CLI_CLIENT_DOMAIN
    exit-code: 0
    stderr:
      contains: 
        - "Default tenant switched to:"

  tenants open:
    command: auth0 tenants open $AUTH0_CLI_CLIENT_DOMAIN --no-input
    exit-code: 0
    stderr:
      contains: 
        - "Open the following URL in a browser: https://manage.auth0.com/dashboard/"
